
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://xvflgagfwqwfjjrjknby.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2ZmxnYWdmd3F3ZmpqcmprbmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyNTk1NDMsImV4cCI6MjA1OTgzNTU0M30.CT6SZhSf5qZBVCWkXz2nwSInmZedtkLmdKp42PQ6_lo";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// Using any type temporarily until Database types can be properly updated
export const supabase = createClient<any>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

// Create a function to execute SQL directly
export const executeSQL = async (sql: string): Promise<{ success: boolean; data?: any; error?: any }> => {
  try {
    console.log("Executing SQL:", sql);
    
    // For SELECT queries, use the native query method instead of rpc
    if (sql.trim().toLowerCase().startsWith('select')) {
      const { data, error } = await supabase.rpc('exec_sql_select', { query: sql });
      
      if (error) {
        console.error("Error executing SELECT SQL:", error);
        return { success: false, error };
      }
      
      return { success: true, data };
    } else {
      // For other queries (INSERT, UPDATE, etc.), use the exec_sql function
      const { error } = await supabase.rpc('exec_sql', { query: sql });
      
      if (error) {
        console.error("Error executing SQL:", error);
        return { success: false, error };
      }
      
      return { success: true };
    }
  } catch (error) {
    console.error("Exception executing SQL:", error);
    return { success: false, error };
  }
};

// Create the required SQL functions if they don't exist
const setupSQLFunctions = async () => {
  try {
    console.log("Setting up SQL functions...");
    
    try {
      // Create exec_sql function for non-select queries
      await supabase.rpc('exec_sql', { 
        query: `
          CREATE OR REPLACE FUNCTION exec_sql(query text)
          RETURNS void
          LANGUAGE plpgsql
          SECURITY DEFINER
          AS $$
          BEGIN
            EXECUTE query;
          END;
          $$;
        `
      }).then(({ error }) => {
        if (error) {
          console.log("Error or function already exists, trying alternative approach:", error);
          return supabase.rpc('exec_sql', { 
            query: "SELECT 1 as test" 
          });
        }
      });
      
      // Create exec_sql_select function for SELECT queries
      await supabase.rpc('exec_sql', { 
        query: `
          CREATE OR REPLACE FUNCTION exec_sql_select(query text)
          RETURNS SETOF json
          LANGUAGE plpgsql
          SECURITY DEFINER
          AS $$
          BEGIN
            RETURN QUERY EXECUTE query;
          END;
          $$;
        `
      }).then(({ error }) => {
        if (error) {
          console.log("Error creating select function, it might already exist:", error);
        } else {
          console.log("exec_sql_select function created successfully");
        }
      });
      
    } catch (err) {
      console.error("Error creating SQL functions:", err);
      
      // Try an alternative approach using direct REST API calls
      console.log("Trying alternative approach to create functions...");
      const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/exec_sql`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_PUBLISHABLE_KEY,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({
          query: `
            CREATE OR REPLACE FUNCTION exec_sql(query text)
            RETURNS void
            LANGUAGE plpgsql
            SECURITY DEFINER
            AS $$
            BEGIN
              EXECUTE query;
            END;
            $$;
            
            CREATE OR REPLACE FUNCTION exec_sql_select(query text)
            RETURNS SETOF json
            LANGUAGE plpgsql
            SECURITY DEFINER
            AS $$
            BEGIN
              RETURN QUERY EXECUTE query;
            END;
            $$;
          `
        })
      });
      
      if (!response.ok) {
        console.error("Failed to create SQL functions via REST API");
      } else {
        console.log("SQL functions created successfully via REST API");
      }
    }
    
    // Verify the functions work
    const testResult = await supabase.rpc('exec_sql_select', { 
      query: "SELECT 1 as test" 
    });
    
    console.log("SQL function test result:", testResult);
    
  } catch (err) {
    console.error("Error in setupSQLFunctions:", err);
  }
};

// Setup required functions when app loads
(async () => {
  try {
    await setupSQLFunctions();
    console.log("SQL functions setup complete");
  } catch (err) {
    console.error("Error in SQL functions setup:", err);
  }
})();
